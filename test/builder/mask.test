var Files =  {
	'main.mask': `
		import Letter from './compos/Letter';
		Letter;
	`,
	'compos/Letter.mask': `
		define Letter {
			h4 > 'I am an A';
		}
	`,
	'global.mask': `
		import from './main';
		i > 'Lorem'
	`,
	'index.html': `
		<!doctype html>		
		<script type='text/mask' data-run='auto'>
			import from 'global.mask';
		</script>
		`
};

var Bundler, mask;
UTest({
	$before () {
		TestHelper.registerFiles(Files);

		mask = require('maskjs');
		Bundler = require('../../lib/bundler.js');

	},
	'should bundle mask' () {
		return Bundler.clearCache().build('main.mask', {}).done(resources => {
			eq_(resources.length, 1);
			var main = resources[0];
			
			eq_(main.type, 'mask'); 
			eq_(main.url, 'build/release/main.mask');

			var load = assert.avoid('Should not load the dependency');
			mask.cfg('getFile', load);

			var  html = mask.render(main.content)
			has_(html, 'I am an A</h4>')
			mask.cfg('getFile', null)
		});
	},
	'should get mask resources for html' () {
		return Bundler
			.clearCache()
			.getResources('index.html')
			.then(arr => arr.map(x => x.toJSON(false)))
			.done(arr => {			
				eq_(arr.length, 4);

				var paths = arr.map(x => x.url);
				deepEq_(paths, ['compos/Letter.mask', 'main.mask', 'global.mask', 'index.html']);

				var asModules = arr.map(x => x.asModules);
				deepEq_(asModules, [['mask'], ['mask'], ['mask'], ['root']]);
			});
	},
	'should bundle mask in html page' () {
		return Bundler.clearCache().build('index.html').done(resources => {
			
			eq_(resources.length, 1);
			eq_(resources[0].type, 'html');
			var main = resources[0];
			eq_(main.url, 'build/release/index.html');

			['compos/Letter.mask', 'main.mask', 'global.mask']
				.forEach(path => has_(main.content, `module path="${path}"`));

		});
	},
	'!should test mask sync module loading' (done) {

		var Files = {
			'MyComponents.mask': `
				module path='A.mask' {
					h1 > 'A'
				}
				module path='B.mask' {
					h1 > 'B'
				}
				module path='C.mask' {
					h1 > 'C'
				}
			`,
			'MyNumber.mask': `
				import * as Template from './B';
				Template;
			`
		};
		var _queue = [];
		mask.cfg('getFile', (path) => {
			var dfr = new mask.class.Deferred();
			var name = path.substring(path.lastIndexOf('/') + 1);
			var str = Files[name];			
			is_(str, 'String');
			_queue.push(name);
			if (name === 'MyComponents.mask') {
				setTimeout(() => dfr.resolve(str), 200);
				return dfr;
			}
			return dfr.resolve(str);
		});

		mask
		.renderAsync(`
			import sync from './MyComponents';
			import Number from './MyNumber';
		`)
		.done(x => {
			mask.cfg('getFile', null);
			deepEq_(_queue, ['MyComponents.mask', 'MyNumber.mask']);
			done();
		})
		

	}
})